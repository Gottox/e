#include "../fuzzer/rope_deser.h"
#include <rope.h>
#include <testlib.h>

#define CRASH_TEST(name, ...) \
	static void name(void) { \
		struct Rope rope = {0}; \
		static const uint8_t serialized_data[] = {__VA_ARGS__}; \
		(void)rope_deserialize( \
				&rope, serialized_data, sizeof(serialized_data), true); \
	}

CRASH_TEST(
		crash_1, 0xff, 0xff, 0xfe, 0x9, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x0, 0x0, 0x0, 0x0, 0x2, 0x0, 0x0, 0x0, 0xff, 0xff, 0x0, )

CRASH_TEST(
		crash_2, 0x0a, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x92, 0x96, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,
		0x92, 0x92, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0xff, 0x00, 0x92, 0x90, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff,
		0xff, 0x00, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x00, 0x00, 0xff, 0xff, 0xff,
		0x00, 0xff, 0xff, 0x92, 0x92, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x6d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x80, 0x40, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x92, 0x92, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00,
		0x00, 0xff, 0xff, 0x00, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xef, 0xff, 0xf6, 0x92, 0x92, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00,
		0x00, 0xff, 0xff, 0x00, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x0a, 0x00, 0x01,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0x92, 0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0xef, 0xff, 0xf6, 0x92, 0x92, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00,
		0x25, 0xff, 0x2e, 0xff, 0x00, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0xff, 0x00, 0x92, 0x92, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
		0x40, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x92, 0x92, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x00,
		0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0xff,
		0x00, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xef, 0xff, 0xf6, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0xff,
		0x00, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x05, 0x00, 0xff, 0xff, 0x00, 0x92, 0x92, 0x00, 0x00, 0x00,
		0xff, 0xff, 0x00, 0x92, 0x92, 0x00, 0x40, 0x00, 0x00, 0xff, 0x00, 0x92,
		0x92, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x92, 0x92, 0x00, 0x40, 0x00,
		0x00, 0xff)

static void
crash_2_reduced(void) {
	int rv = 0;
	struct Rope rope = {0};
	struct RopeRange ranges[2] = {0};

	rv = rope_init(&rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[0], &rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[1], &rope);
	ASSERT_EQ(0, rv);

	// Inserting 96 bytes into range 2
	rv = rope_range_insert(
			&ranges[1],
			(const uint8_t *)"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
							 "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
			96, 0x0);
	ASSERT_EQ(0, rv);
	// Inserting 0 bytes into range 0
	rv = rope_range_insert(
			&ranges[0], (const uint8_t *)"", 0, 0xeff250000ff0000);
	ASSERT_EQ(0, rv);
	// Inserting 0 bytes into range 2
	rv = rope_range_insert(
			&ranges[1], (const uint8_t *)"", 0, 0x29200ffff0000ff);

	rope_range_cleanup(&ranges[1]);
	rope_range_cleanup(&ranges[0]);
	rope_cleanup(&rope);
}

static void
crash_2_reduced2(void) {
	int rv = 0;
	struct Rope rope = {0};
	struct RopeRange ranges[2] = {0};

	rv = rope_init(&rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[0], &rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[1], &rope);
	ASSERT_EQ(0, rv);

	// Inserting 1 bytes into range 0
	rv = rope_range_insert(
			&ranges[0], (const uint8_t *)"a", 1, 0xfffffffffffff00);
	ASSERT_EQ(0, rv);
	// Inserting 0 bytes into range 0
	rv = rope_range_insert(
			&ranges[0], (const uint8_t *)"", 0, 0x29200ffff0000);

	rope_range_cleanup(&ranges[1]);
	rope_range_cleanup(&ranges[0]);
	rope_cleanup(&rope);
}

static void
crash_2_reduced3(void) {
	int rv = 0;
	struct Rope rope = {0};
	struct RopeRange range = {0};

	rv = rope_init(&rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&range, &rope);
	ASSERT_EQ(0, rv);

	// Inserting 96 bytes into range 2
	rv = rope_range_insert(
			&range,
			(const uint8_t *)"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
							 "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
			96, 0x0);
	ASSERT_EQ(0, rv);
	// Inserting 0 bytes into range 2
	rv = rope_range_insert(
			&range, (const uint8_t *)"", 0, 0x929200ffff0000ff);
	ASSERT_EQ(0, rv);
	rope_range_cleanup(&range);
	rope_cleanup(&rope);
}

CRASH_TEST(
		crash_3, 0x0a, 0x25, 0x04, 0x00, 0xb1, 0x00, 0x00, 0x00, 0x00, 0x01,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26,
		0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26,
		0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26,
		0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26,
		0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26, 0x26,
		0x26, 0x26, 0x26, 0x26, 0x26, 0xff, 0x20, 0x1c)

static void
crash_3_reduced(void) {
	int rv = 0;
	struct Rope rope = {0};
	struct RopeRange ranges[2] = {0};

	rv = rope_init(&rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[0], &rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[1], &rope);
	ASSERT_EQ(0, rv);

	// Inserting 4 bytes into range 1
	rv = rope_range_insert(
			&ranges[0], (const uint8_t *)"aaaa", 4, 0x2626010000000000);
	ASSERT_EQ(0, rv);
	// Inserting 38 bytes into range 2
	rv = rope_range_insert(
			&ranges[1],
			(const uint8_t *)"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", 38,
			0x2626262626262626);

	rope_range_cleanup(&ranges[1]);
	rope_range_cleanup(&ranges[0]);
	rope_cleanup(&rope);
}

CRASH_TEST(
		crash_4, 0x72, 0x68, 0x02, 0x8b, 0x8a, 0x00, 0x00, 0x10, 0x00, 0x00,
		0x30, 0x00, 0x3d, 0x00, 0x01, 0x01, 0x72, 0xff, 0xff, 0xff, 0x8a, 0x8a,
		0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x02, 0x8b, 0x8a, 0x02, 0x00,
		0x10, 0x00, 0x00, 0x31, 0x00, 0x3d, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x83, 0x72, 0x72, 0x00, 0x68, 0x02, 0x8b, 0x8a, 0x00, 0x00,
		0x10, 0x00, 0x00, 0x35, 0x00, 0x3d, 0x00, 0x01, 0x01, 0x72, 0xff, 0x02,
		0x00, 0x00, 0x00, 0x00, 0x83, 0x72, 0x72)

static void
crash_4_reduced(void) {
	int rv = 0;
	struct Rope rope = {0};
	struct RopeRange ranges[2] = {0};
	rv = rope_init(&rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[0], &rope);
	ASSERT_EQ(0, rv);
	rv = rope_range_init(&ranges[1], &rope);
	ASSERT_EQ(0, rv);

	// Inserting 2 bytes into range 2
	rv = rope_range_insert(
			&ranges[1], (const uint8_t *)"aa", 2, 0xf720101003d0030);
	ASSERT_EQ(0, rv);
	// Inserting 5 bytes into range 0
	rv = rope_range_insert(&ranges[0], (const uint8_t *)"aaaaa", 5, 0x0);
	ASSERT_EQ(0, rv);
	// Inserting 0 bytes into range 2
	rv = rope_range_insert(
			&ranges[1], (const uint8_t *)"", 0, 0x300000000000101);

	rope_range_cleanup(&ranges[1]);
	rope_range_cleanup(&ranges[0]);
	rope_cleanup(&rope);
}

DECLARE_TESTS
TEST(crash_1)
TEST(crash_2)
TEST(crash_2_reduced)
TEST(crash_2_reduced2)
TEST(crash_2_reduced3)
TEST(crash_3)
TEST(crash_3_reduced)
TEST(crash_4)
TEST(crash_4_reduced)
END_TESTS
